Vue.component('vue-datatable',{
  data(){
    return {
      dataTab: [],
      search: '',
      search_context: '',
      sortBy: '',
      order: '',
    }
  },
  props:{
    resource:{
      type:Array,
      required:true
    },
    columns:{
      type:Array,
      required:true
    },
    selectable:{
      type:Boolean,
      required:false
    },
    ajax_on_loading:{
      type:Boolean,
      required:false
    },
    index_column:{
      type:String,
      required:true
    }
  },
  mounted: function(){
    console.log("Datatables Ready...");

    this.search_context = (this.columns.length > 0) ? this.columns[0].context : '';
    this.dataTab = this.data_resource;

  },
  methods:{
      selectMe: function(index){
        this.$emit('selected', index);
      },
      hoverMe: function(index){
        this.$emit('hovered', index);
      },
      changeConteks: function(alpha){
        this.search_context = alpha.target.options[alpha.target.options.selectedIndex].getAttribute('value');
      },
      onTable: function(e){
        if(e.code == 'ArrowDown'){
          $('.vue-datatable-search').blur();
          $('.vue-datatable-row-data').first(0).focus();
        }
      },
      nextRow: function(e){
        switch(e.which){
          case 40:
              if($('.vue-datatable-row-data:focus').next().index() < 0){
                $('.vue-datatable-row-data').first().focus();
              }
              else{
                $('.vue-datatable-row-data:focus').next().focus();
              }
             break;

          case 38:
              if($('.vue-datatable-row-data:focus').prev().index() < 0){
                $('.vue-datatable-row-data').last().focus();
              }
              else{
                $('.vue-datatable-row-data:focus').prev().focus();
              }
            break;
          case 13:
              this.$emit('selected', $('.vue-datatable-row-data:focus').data('id'));
        }
      }
  },
  watch: {
    data_resource: function(value){
      this.dataTab = this.data_resource;
      // console.log(this.dataTab)
    },
    columns: function(){
      // alert('okee');
      this.search_context = (this.columns.length > 0) ? this.columns[0].context : '';
      // console.log(this.search_context);
    },
    search: function(value){
      if(value == ""){ this.dataTab = this.data_resource; return }

      this.search_context = $('#vue-datatable-search-context').val();
      mine = this;

      var data = this.data_resource.filter(function(o){
        for(var alpha = 0; alpha < mine.columns.length; alpha++){
          if(o[mine.columns[alpha].context].toString().toUpperCase().includes(value.toUpperCase())) return o;
        }
      })

      this.dataTab = data;
    }
  },
  computed:{
    
  },
  template: `

      <div class="row">
        <!-- <div class="col-md-2 col-sm-4 col-xs-4 form-datatable-vue" style="padding: 0px 0px 0px 15px;">
          <select class="form-control modul-keuangan" style="cursor: pointer" id="vue-datatable-search-context" title="Pencarian Berdasarkan"  @change="changeConteks">
              <option :value="column.context" v-for="column in columns">{{ column.name }}</option>
          </select>
        </div> -->

        <div class="col-md-3 col-sm-5 col-xs-5 form-datatable-vue" style="padding: 0px 0px 0px 20px;">
          <input type="text" class="form-control modul-keuangan vue-datatable-search" v-model="search" style="background:white;" placeholder="Kata Kunci..." @keydown="onTable">
        </div>

        <div class="col-md-12 col-sm-12 col-xs-12" style="margin-top: 15px; height: 300px; overflow-y: scroll; background: white">
          <table class="table" id="vue-datatable">
            <thead>
              <tr>
                <th>No</th>
                <th v-for="column in columns" :width="column.width">{{ column.name }}</th>
              </tr>
            </thead>

            <tbody>
              <tr v-if="ajax_on_loading">
                <td :colspan="columns.length + 1" style="text-align: center"> Sedang Mengumpulkan Data. Harap Tunggu...  </td>
              </tr>

              <tr v-if="dataTab.length == 0 && !ajax_on_loading">
                <td :colspan="columns.length + 1" style="text-align: center"> Tidak Ada Data </td>
              </tr>

              <tr :data-id="data[index_column]" :tabindex="idx" v-for="(data, idx) in dataTab" :class="selectable ? 'selectable vue-datatable-row-data' : 'vue-datatable-row-data'" @click="selectMe(data[index_column])" @mouseover="hoverMe(data[index_column])" @keydown="nextRow">
                <td>
                  <input :value="idx+1" style="width:30px; text-align: center; outline: none; border: none;" readonly class="arrow-nav" :id="'datatable_row_'+idx"></input> 
                </td>
                <td v-for="column in columns" :style="column.childStyle" v-html="(!column.override) ? data[column.context] : column.override(data[column.context])"></td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      
  `
});